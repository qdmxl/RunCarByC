# RunCarByC
    摘要
本次实训是基于Raspberry系统设计的智能小车。整车以Raspberry 3B为核心控制单元，以蓝牙通讯作为串口通讯，在移动端和小车之间建立联系，用SPP和JuiceSSH两个软件按功能发送相应控制指令。车体通过红外避障模块和超声波测距模块检测识别赛道，并用算法控制小车的转角和四个驱动电机的行停。利用C#编写相应的迷宫算法、移动端遥控，通过测试和运行，实现了智能车自主走迷宫、安卓控制（按键）两大功能。

1 系统定义

1.1设计实现的功能

  1.在小车本体上，用C编程，实现小车自主走迷宫及遥控程序。
  
  2.手机遥控：通过已有手机APP（SPP/JuiceSSH），提供小车运动控制界面，通过手机APP界面控制小车的运动。 
  
1.2可行性分析

  1.要完成迷宫程序，首先需要完成小车的避障和转弯行进两项基本功能。本车采用红外超声波避障，我们可以在原有小车的基础上，在它车头两侧分别加上一个红外线感控装置，这个红外感控可以通过调试将测距避障的距离设置在最佳的位置。因为本车有三个超声波，也就是在小车的车头和两侧，能很好的检测周围赛道的情况。为了能更好的分析在测试中出现的故障，我们可以写两个测试红外和超声的代码，在小车运行中可以实时的传回数据。
  
  2.而安卓端的实现，首先需要APP以及可以和小车进行联系的媒介。这里我们可以采用现成的APP（SPP/JuiceSSH）,通过手机wifi连接上小车的wifi，手机蓝牙作为串口通讯的媒介，这样就可以简单方便的实现安卓端的控制。
  
1.3需求分析

  1.跑迷宫的时候不允许采用遥控、人工干预等方式，需要小车自主跑出迷宫。不能卡住，也不能碰壁。
  2.移动端遥控尽量简单易上手，成功率高。
  
2 系统总体设计

2.1总体设计方案的确定

  树莓派智能小车服务主要实现的功能是实现避障功能，并接受手机客户端传过来的命令，并对命令做出正确的响应。
智能小车服务端的功能分两个模块实现， 分别为与手机客户端的通讯模块和小车运动模块。 这两个模块都是比较容易实现的， 小车端的通讯模块采用蓝牙串口通信。 小车的运动模块主要是通过小车中已经存在的中间件调用小车的 4个直流减速电机来实现小车的前进、 后退、 左转、 右转、 停止等功能。 小车的自动避障功能通过调用小车的超声波传感器来实现。

  关于无线通信模块，有两种实现方式，一种是通过树莓派建立WIFI热点，然后通过手机连接树莓派的WIFI，由客户端建立TCP连接，实现对小车的控制。另一种是通过蓝牙，用手机连接树莓派上的蓝牙模块，然后将指令通过蓝牙串口透传到树莓派。两种方式各有优缺点，WIFI的方式可扩展性比较好，但是实现起来相对复杂，而且手机连接树莓派的WIFI会无法上网，而采用蓝牙串口的方式能避免这个问题，所以决定采用蓝牙串口的方式来实现树莓派小车的远程控制。”
  
2.2软硬件功能划分

  树莓派智能小车服务端要实现的主要功能是接收手机客户端传过来的命令， 并对命令做出正确的响应。命令主要是控制小车的模式，其中模式包含避障模式和遥控模式。命令通过蓝牙串口的方式进行传输，当切换到避障模式时，相关的逻辑由服务端的软件实现。
  
2.3 硬件体系架构设计

  整个小车以树莓派3为核心，为了能实现最基本的避障功能，我们为小车配备了一些传感器。我们使用HC-SR04超声波测距传感器和红外光电避障传感器，其中红外光电传感器具有一堆红外线发射与接收管，运行时发射管会发出一定频率的红外线，当检测方向遇到障碍物时，红外线会反射回来被接收管接收，经过比较电路处理后，信号输出接口会输出一个低电平信号，只要在程序中对该接口的电平进行判断就能知道小车是否距离障碍物比较近。
  
  超声波测距是通过测量超声波从发射到遇到障物反射到被接收这整个过程中的时间差来确定距离， 超声波传感器使用比较方便且价格便宜，具有信息处理简单， 实时性强和价格低廉等特点， 但实际使用中由于超声波发射束角过大， 方向性差， 只能得到障碍物简单的距离信息， 无法得到障碍物的边界信息。 而红外光电传感器具有探测视角小， 方向性强等特点， 但无法确定障碍物的距离信息。 因此在本作品中， 创新使用了超声波传感器和红外光电传感器相结合的方式。 

2.4 软件体系架构设计

由distance、motor、uart、task四个模块构成，通过串口转蓝牙通信在手机端实现对小车的测试超声波、测试红外、走迷宫、遥控四个功能。
  
distance：实现超声波测距及红外避障，包括初始化函数及距离检测更新函数，实现硬件功能的函数

motor：实现对电机的初始化，控制电机转动、停止的函数，包括电机的PWM调速的设置，用run()函数检测小车前、左、右方，使左右两侧的轮子速度同步，不需要考虑        底层。

uart：配置串口，通过串口转成蓝牙协议，再通过手机app进行通信，本质上是串口通信，包括串口初始化和一些数据包的解析。

task：实现超声波检测距离，红外检测障碍，走迷宫，遥控四个功能，并整合到一个任务函数里。

main：调用前面定义的函数，初始化超声波测距，初始化红外避障，初始化电机，打开串口；再调用任务函数并接收发过去的数据，根据收到的命令标记任务，判断调用       的功能函数。
